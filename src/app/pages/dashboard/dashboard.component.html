<div class="dashboard-container">
  <div *ngIf="user?.role === 'Operatore'" class="operator-view">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Benvenuto, {{ user?.name }}!</mat-card-title>
        <mat-card-subtitle>Utilizza il menu per navigare nella piattaforma.</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="quick-actions">
        <a mat-stroked-button color="primary" routerLink="/reports/new">
          <mat-icon>add_circle_outline</mat-icon>
          Nuova Segnalazione
        </a>
        <a mat-stroked-button routerLink="/reports">
          <mat-icon>list_alt</mat-icon>
          Vedi Archivio
        </a>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="user?.role === 'Analista' || user?.role === 'Admin'">
    <div class="header">
      <h1>Dashboard Analitica</h1>
      <p>Panoramica in tempo reale delle segnalazioni di farmacovigilanza.</p>
    </div>

    <div *ngIf="isLoading" class="loading-spinner">
      <mat-spinner></mat-spinner>
    </div>
    <div *ngIf="error" class="error-message">{{ error }}</div>

    <div *ngIf="summaryData" class="dashboard-grid">
      <mat-card class="kpi-card kpi-card--blue">
        <mat-icon>receipt_long</mat-icon>
        <div class="kpi-content">
          <div class="kpi-value">{{ summaryData.totalReports }}</div>
          <div class="kpi-label">Segnalazioni Totali</div>
        </div>
      </mat-card>

      <mat-card class="kpi-card kpi-card--orange">
        <mat-icon>local_pharmacy</mat-icon>
        <div class="kpi-content">
          <div class="kpi-value">{{ summaryData.top5Drugs[0]?._id || 'N/D' }}</div>
          <div class="kpi-label">Farmaco pi√π Segnalato</div>
        </div>
      </mat-card>

      <mat-card class="kpi-card" [ngClass]="getEsitoClass(summaryData.reportsBySeverity[0]?._id)">
        <mat-icon>healing</mat-icon>
        <div class="kpi-content">
          <div class="kpi-value">{{ summaryData.reportsBySeverity[0]?._id || 'N/D' }}</div>
          <div class="kpi-label">Esito Prevalente</div>
        </div>
      </mat-card>

      <mat-card class="kpi-card kpi-card--red">
        <mat-icon>warning_amber</mat-icon>
        <div class="kpi-content">
          <div class="kpi-value">{{ summaryData.totalGraveReports }}</div>
          <div class="kpi-label">Segnalazioni Gravi</div>
        </div>
      </mat-card>

      <mat-card class="recent-reports-card">
        <mat-card-title>Ultime 5 Segnalazioni</mat-card-title>
        <mat-card-content>
          <mat-list>
            <mat-list-item *ngFor="let report of summaryData.last5Reports">

              <mat-icon mat-list-icon [ngClass]="getEsitoClass(report.reazione.esito)">article</mat-icon>

              <div mat-line>{{ report.farmaciSospetti[0]?.nomeCommerciale }}</div>
              <div mat-line class="list-subtitle">{{ report.reazione.esito }} | {{ report.createdAt | date:'dd/MM/yy HH:mm' }}</div>
            </mat-list-item>
          </mat-list>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-title>Origine Segnalazioni</mat-card-title>
        <mat-card-content>
          <ngx-charts-pie-chart [results]="sourceChartData" [labels]="true"></ngx-charts-pie-chart>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-title>Segnalazioni per Esito</mat-card-title>
        <mat-card-content>
          <ngx-charts-pie-chart [results]="severityChartData" [labels]="true" [doughnut]="true"></ngx-charts-pie-chart>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-title>Distribuzione per Sesso</mat-card-title>
        <mat-card-content>
          <ngx-charts-pie-chart [results]="genderChartData" [labels]="true"></ngx-charts-pie-chart>
        </mat-card-content>
      </mat-card>

      <mat-card class="map-card">
        <div class="map-wrapper">
          <mat-card-title><mat-icon>public</mat-icon> Distribuzione Geografica</mat-card-title>
          <div #mapContainer id="map"></div>
        </div>
        <div class="map-wrapper">
          <mat-card-title><mat-icon>whatshot</mat-icon> Heatmap Segnalazioni</mat-card-title>
          <div #heatmapContainer id="heatmap"></div>
        </div>
      </mat-card>

    </div>
  </div>
</div>
