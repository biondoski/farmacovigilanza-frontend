<div class="dashboard-container">
  <div *ngIf="user?.role === 'Operatore'">
    <h2>Benvenuto, {{ user?.name }}!</h2>
    <p>Utilizza il menu a sinistra per navigare nella piattaforma e inserire nuove segnalazioni.</p>
    <div class="quick-actions">
      <a routerLink="/reports/new" class="action-card">
        <h3>Nuova Segnalazione</h3>
        <p>Crea una nuova segnalazione di reazione avversa.</p>
      </a>
      <a routerLink="/reports" class="action-card">
        <h3>Vedi Archivio</h3>
        <p>Consulta tutte le segnalazioni inserite.</p>
      </a>
    </div>
  </div>

  <div *ngIf="user?.role === 'Analista' || user?.role === 'Admin'">
    <div class="header">
      <h1>Dashboard Analitica</h1>
      <p>Panoramica in tempo reale delle segnalazioni di farmacovigilanza.</p>
    </div>

    <div *ngIf="isLoading" class="loading">Caricamento dati...</div>
    <div *ngIf="error" class="error">{{ error }}</div>

    <div *ngIf="summaryData" class="dashboard-grid">
      <div class="card kpi-card">
        <fa-icon [icon]="faNotesMedical" size="2x"></fa-icon>
        <div class="kpi-content">
          <div class="kpi-value">{{ summaryData.totalReports }}</div>
          <div class="kpi-label">Segnalazioni Totali</div>
        </div>
      </div>
      <div class="card kpi-card">
        <fa-icon [icon]="faCapsules" size="2x"></fa-icon>
        <div class="kpi-content">
          <div class="kpi-value">{{ summaryData.top5Drugs[0]?._id || 'N/D' }}</div>
          <div class="kpi-label">Farmaco pi√π Segnalato</div>
        </div>
      </div>
      <div class="card kpi-card">
        <fa-icon [icon]="faExclamationTriangle" size="2x"></fa-icon>
        <div class="kpi-content">
          <div class="kpi-value">{{ summaryData.reportsBySeverity[0]?._id || 'N/D' }}</div>
          <div class="kpi-label">Esito Prevalente</div>
        </div>
      </div>
      <div class="card kpi-card kpi-card--danger">
        <fa-icon [icon]="faBiohazard" size="2x"></fa-icon>
        <div class="kpi-content">
          <div class="kpi-value">{{ summaryData.totalGraveReports }}</div>
          <div class="kpi-label">Segnalazioni Gravi</div>
        </div>
      </div>

      <div class="card recent-reports-card">
        <h3>Ultime 5 Segnalazioni</h3>
        <ul>
          <li *ngFor="let report of summaryData.last5Reports">
            <span class="farmaco">{{ report.farmaciSospetti[0]?.nomeCommerciale }}</span>
            <span class="gravita-badge">{{ report.reazione.esito }}</span>
            <span class="data">{{ report.createdAt | date:'dd/MM/yy HH:mm' }}</span>
          </li>
        </ul>
      </div>

      <div class="card chart-card">
        <h3><fa-icon [icon]="faUserMd"></fa-icon> Origine Segnalazioni</h3>
        <ngx-charts-pie-chart
          [results]="sourceChartData"
          [labels]="true">
        </ngx-charts-pie-chart>
      </div>

      <div class="card chart-card">
        <h3>Segnalazioni per Esito</h3>
        <ngx-charts-pie-chart
          [results]="severityChartData"
          [labels]="true"
          [doughnut]="true"
          [legendPosition]="legendPositionValue">
        </ngx-charts-pie-chart>
      </div>

      <div class="card chart-card">
        <h3><fa-icon [icon]="faVenusMars"></fa-icon> Distribuzione per Sesso</h3>
        <ngx-charts-pie-chart
          [results]="genderChartData"
          [labels]="true">
        </ngx-charts-pie-chart>
      </div>

      <div class="card map-card">
        <div class="map-wrapper">
          <h3>
            <fa-icon [icon]="faGlobeEurope"></fa-icon>
            Distribuzione Geografica (Marker)
          </h3>
          <div #mapContainer id="map"></div>
        </div>
        <div class="map-wrapper">
          <h3>
            <fa-icon [icon]="faBiohazard"></fa-icon>
            Heatmap delle Segnalazioni
          </h3>
          <div #heatmapContainer id="heatmap"></div>
        </div>
      </div>

    </div>
  </div>
</div>
