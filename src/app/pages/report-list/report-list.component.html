<div class="list-container">
  <div class="header-controls">
    <h1>Archivio Segnalazioni</h1>
    <div class="actions">
      <button mat-stroked-button (click)="onExport()">
        <mat-icon>download</mat-icon>
        Esporta CSV
      </button>
      <a mat-flat-button color="primary" routerLink="/reports/new">
        <mat-icon>add_circle_outline</mat-icon>
        Aggiungi Segnalazione
      </a>
    </div>
  </div>

  <mat-card class="filter-card">
    <form [formGroup]="filterForm">
      <mat-form-field appearance="outline">
        <mat-label>Filtra per farmaco</mat-label>
        <input matInput formControlName="farmaco">
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Data Da</mat-label>
        <input matInput type="date" formControlName="dataDa">
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Data A</mat-label>
        <input matInput type="date" formControlName="dataA">
      </mat-form-field>
    </form>
  </mat-card>

  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner></mat-spinner>
  </div>
  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div *ngIf="!isLoading && !error" class="table-container mat-elevation-z4">
    <table mat-table [dataSource]="paginatedData?.reports || []" multiTemplateDataRows class="report-table">

      <ng-container matColumnDef="data">
        <th mat-header-cell *matHeaderCellDef (click)="onSort('createdAt')">Data</th>
        <td mat-cell *matCellDef="let report" data-label="Data">{{ report.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
      </ng-container>

      <ng-container matColumnDef="farmaco">
        <th mat-header-cell *matHeaderCellDef>Farmaco Sospetto</th>
        <td mat-cell *matCellDef="let report" data-label="Farmaco">{{ report.farmaciSospetti[0]?.nomeCommerciale || 'N/D' }}</td>
      </ng-container>

      <ng-container matColumnDef="eta">
        <th mat-header-cell *matHeaderCellDef (click)="onSort('paziente.eta')">Età</th>
        <td mat-cell *matCellDef="let report" data-label="Età">{{ report.paziente.eta }}</td>
      </ng-container>

      <ng-container matColumnDef="esito">
        <th mat-header-cell *matHeaderCellDef>Esito</th>
        <td mat-cell *matCellDef="let report" data-label="Esito">{{ report.reazione.esito }}</td>
      </ng-container>

      <ng-container matColumnDef="gravita">
        <th mat-header-cell *matHeaderCellDef>Gravità</th>
        <td mat-cell *matCellDef="let report" data-label="Gravità">
          <span class="gravita-badge" [class.gravita-grave]="report.reazione.gravita.isGrave" [class.gravita-lieve]="!report.reazione.gravita.isGrave">
            {{ report.reazione.gravita.isGrave ? 'Grave' : 'Non Grave' }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="segnalatore">
        <th mat-header-cell *matHeaderCellDef>Inserito da</th>
        <td mat-cell *matCellDef="let report" data-label="Inserito da">{{ report.submittedBy?.name || 'Anonimo' }}</td>
      </ng-container>

      <ng-container matColumnDef="azioni">
        <th mat-header-cell *matHeaderCellDef>Azioni</th>
        <td mat-cell *matCellDef="let report" data-label="Azioni">
          <button mat-icon-button color="primary" [routerLink]="['/reports/edit', report._id]" aria-label="Modifica segnalazione">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="accent" (click)="expandedElement = (expandedElement === report ? null : report)" aria-label="Mostra dettagli">
            <mat-icon>{{expandedElement === report ? 'expand_less' : 'expand_more'}}</mat-icon>
          </button>
        </td>
      </ng-container>

      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let report" [attr.colspan]="displayedColumns.length">
          <div class="report-detail" [@detailExpand]="report === expandedElement ? 'expanded' : 'collapsed'">
            <div class="detail-grid">
              <div><strong>Descrizione Reazione:</strong> {{ report.reazione.descrizione }}</div>
              <div><strong>Principio Attivo:</strong> {{ report.farmaciSospetti[0]?.principioAttivo || 'N/D' }}</div>
              <div><strong>Lotto:</strong> {{ report.farmaciSospetti[0]?.lotto || 'N/D' }}</div>
              <div><strong>Paziente:</strong> {{report.paziente.sesso}}, {{report.paziente.peso}}kg, {{report.paziente.altezza}}cm</div>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let report; columns: displayedColumns;"
          class="report-row"
          [class.expanded-row]="expandedElement === report">
      </tr>
      <tr mat-row *matRowDef="let report; columns: ['expandedDetail']" class="detail-row"></tr>

    </table>

    <mat-paginator *ngIf="paginatedData && paginatedData.totalPages > 0"
                   [length]="paginatedData.totalPages * 10"
                   [pageSize]="10"
                   [pageIndex]="currentPage - 1"
                   (page)="handlePageEvent($event)"
                   aria-label="Seleziona pagina">
    </mat-paginator>

  </div>
</div>
