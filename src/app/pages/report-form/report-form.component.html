<div class="form-container">
  <h1>{{ isEditMode ? 'Modifica Segnalazione' : 'Nuova Segnalazione ADR' }}</h1>
  <p>Compila la scheda in tutte le sue parti. I campi contrassegnati con * sono obbligatori.</p>

  <form [formGroup]="reportForm" (ngSubmit)="onSubmit()">

    <mat-card appearance="outlined">
      <mat-card-header>
        <mat-card-title>Tipo di Segnalazione</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline">
          <mat-label>Tipo Segnalazione*</mat-label>
          <mat-select formControlName="tipoSegnalazione">
            <mat-option value="Cittadino">Da Cittadino/Paziente</mat-option>
            <mat-option value="Sanitario">Da Operatore Sanitario</mat-option>
          </mat-select>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined" formGroupName="paziente">
      <mat-card-header>
        <mat-card-title>1. Informazioni sul Paziente</mat-card-title>
      </mat-card-header>
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Iniziali*</mat-label>
          <input matInput formControlName="iniziali" maxlength="3">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Età*</mat-label>
          <input matInput type="number" formControlName="eta">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Sesso*</mat-label>
          <mat-select formControlName="sesso">
            <mat-option value="M">Maschio</mat-option>
            <mat-option value="F">Femmina</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Peso (kg)</mat-label>
          <input matInput type="number" formControlName="peso">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Altezza (cm)</mat-label>
          <input matInput type="number" formControlName="altezza">
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined" formGroupName="reazione">
      <mat-card-header>
        <mat-card-title>2. Descrizione della Reazione Avversa (ADR)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline">
          <mat-label>Descrizione completa della reazione*</mat-label>
          <textarea matInput rows="4" formControlName="descrizione"></textarea>
        </mat-form-field>
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Data di Inizio*</mat-label>
            <input matInput type="date" formControlName="dataInizio">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Esito della Reazione*</mat-label>
            <mat-select formControlName="esito">
              <mat-option value="Guarigione completa">Guarigione completa</mat-option>
              <mat-option value="In via di guarigione">In via di guarigione</mat-option>
              <mat-option value="Guarigione con postumi">Guarigione con postumi</mat-option>
              <mat-option value="Persistenza della reazione">Persistenza della reazione</mat-option>
              <mat-option value="Decesso">Decesso</mat-option>
              <mat-option value="Sconosciuto">Sconosciuto</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div formGroupName="gravita" class="checkbox-group">
          <mat-checkbox formControlName="isGrave">La reazione è grave?</mat-checkbox>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined" formArrayName="farmaciSospetti">
      <mat-card-header>
        <mat-card-title>3. Farmaci Sospetti</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngFor="let farmaco of farmaciSospetti.controls; let i = index" [formGroupName]="i" class="form-array-item">
          <div class="form-array-header">
            <h4>Farmaco Sospetto #{{ i + 1 }}</h4>
            <button type="button" mat-icon-button color="warn" (click)="rimuoviFarmacoSospetto(i)" *ngIf="farmaciSospetti.controls.length > 1">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          <div class="form-grid">
            <mat-form-field appearance="outline"><mat-label>Nome Commerciale*</mat-label><input matInput formControlName="nomeCommerciale"></mat-form-field>
            <mat-form-field appearance="outline"><mat-label>Principio Attivo</mat-label><input matInput formControlName="principioAttivo"></mat-form-field>
            <mat-form-field appearance="outline"><mat-label>N. Lotto</mat-label><input matInput formControlName="lotto"></mat-form-field>
            <mat-form-field appearance="outline"><mat-label>Dosaggio</mat-label><input matInput formControlName="dosaggio"></mat-form-field>
            <mat-form-field appearance="outline"><mat-label>Data Inizio Terapia</mat-label><input matInput type="date" formControlName="dataInizioTerapia"></mat-form-field>
            <mat-form-field appearance="outline"><mat-label>Data Fine Terapia</mat-label><input matInput type="date" formControlName="dataFineTerapia"></mat-form-field>
          </div>
        </div>
        <button type="button" mat-stroked-button (click)="aggiungiFarmacoSospetto()">
          <mat-icon>add</mat-icon> Aggiungi Farmaco Sospetto
        </button>
      </mat-card-content>
    </mat-card>

    <div class="form-actions">
      <button type="submit" mat-flat-button color="primary" [disabled]="reportForm.invalid || isLoading">
        {{ isLoading ? 'Salvataggio...' : (isEditMode ? 'Salva Modifiche' : 'Invia Segnalazione') }}
      </button>
      <a mat-button routerLink="/reports">Annulla</a>
    </div>
    <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>
  </form>
</div>
