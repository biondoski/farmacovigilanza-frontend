<div class="analytics-container">
  <h1>Analytics Avanzate</h1>

  <mat-card appearance="outlined" class="filter-card">
    <mat-card-content>
      <form [formGroup]="filterForm" (ngSubmit)="applyFilters()">
        <mat-form-field appearance="outline">
          <mat-label>Nome Farmaco (opzionale)</mat-label>
          <input matInput formControlName="farmaco">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Data Da</mat-label>
          <input matInput type="date" formControlName="dataDa">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Data A</mat-label>
          <input matInput type="date" formControlName="dataA">
        </mat-form-field>
        <button mat-flat-button color="primary" type="submit" [disabled]="isLoading">
          <mat-icon>filter_list</mat-icon>
          {{ isLoading ? 'Analisi...' : 'Applica Filtri' }}
        </button>
      </form>
    </mat-card-content>
  </mat-card>

  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner></mat-spinner>
    <p>Analisi dei dati in corso...</p>
  </div>

  <div *ngIf="!isLoading" class="analytics-grid">
    <mat-card>
      <mat-card-title>Segnalazioni per Farmaco</mat-card-title>
      <mat-card-subtitle>Clicca su una barra per vedere i dettagli</mat-card-subtitle>
      <mat-card-content class="chart-container">
        <ngx-charts-bar-vertical
          (select)="onChartClick($event)"
          [results]="reportsByDrugData"
          [xAxis]="true"
          [yAxis]="true"
          xAxisLabel="Farmaco"
          yAxisLabel="Numero di Segnalazioni">
        </ngx-charts-bar-vertical>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-title>Segnalazioni per Esito</mat-card-title>
      <mat-card-content class="chart-container">
        <ngx-charts-pie-chart
          [results]="reportsBySeverityData"
          [labels]="true"
          [doughnut]="true">
        </ngx-charts-pie-chart>
      </mat-card-content>
    </mat-card>

    <mat-card *ngIf="filterForm.value.farmaco && hotLotsData.length > 0" class="lot-card">
      <mat-card-title>Lotti più Segnalati per: <strong>{{ filterForm.value.farmaco }}</strong></mat-card-title>
      <mat-card-content class="table-container">
        <table mat-table [dataSource]="hotLotsData">
          <ng-container matColumnDef="lotto">
            <th mat-header-cell *matHeaderCellDef> N° Lotto </th>
            <td mat-cell *matCellDef="let lot"> {{lot._id}} </td>
          </ng-container>
          <ng-container matColumnDef="totali">
            <th mat-header-cell *matHeaderCellDef> Totali </th>
            <td mat-cell *matCellDef="let lot"> {{lot.segnalazioniTotali}} </td>
          </ng-container>
          <ng-container matColumnDef="gravi">
            <th mat-header-cell *matHeaderCellDef> Gravi </th>
            <td mat-cell *matCellDef="let lot" class="danger-text"> {{lot.segnalazioniGravi}} </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="['lotto', 'totali', 'gravi']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['lotto', 'totali', 'gravi'];"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-title>Segnalazioni per Fascia d'Età</mat-card-title>
      <mat-card-content class="chart-container">
        <ngx-charts-bar-vertical
          [results]="ageAnalysisData"
          [xAxis]="true"
          [yAxis]="true"
          xAxisLabel="Fascia d'Età"
          yAxisLabel="Numero di Segnalazioni">
        </ngx-charts-bar-vertical>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-title>Distribuzione per Sesso</mat-card-title>
      <mat-card-content class="chart-container">
        <ngx-charts-pie-chart
          [results]="genderAnalysisData"
          [labels]="true">
        </ngx-charts-pie-chart>
      </mat-card-content>
    </mat-card>

    <mat-card class="heatmap-card" *ngIf="symptomCorrelationData.length > 0">
      <mat-card-title>Correlazione tra Sintomi</mat-card-title>
      <mat-card-subtitle>Quali sintomi appaiono più spesso insieme</mat-card-subtitle>
      <mat-card-content class="chart-container">
        <ngx-charts-heat-map
          [results]="symptomCorrelationData"
          [xAxis]="true"
          [yAxis]="true"
          [legend]="true"
          [showXAxisLabel]="true"
          [showYAxisLabel]="true"
          xAxisLabel="Sintomi"
          yAxisLabel="Sintomi">
        </ngx-charts-heat-map>
      </mat-card-content>
    </mat-card>

  </div>
</div>
